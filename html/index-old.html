<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shifted Storage IPFS Cluster UI</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#0c0c0f;color:#e9e9ee;margin:0}
    header{padding:14px 18px;border-bottom:1px solid #222} h1{margin:0;font-size:18px}
    main{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#141419;border:1px solid #272733;border-radius:14px;padding:16px;margin:14px 0}
    .drop{border:2px dashed #3a3a44;border-radius:12px;padding:28px;text-align:center}
    .drop.drag{background:#191924;border-color:#6b6bff}
    button{background:#2c2cff;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .secondary{background:#2a2a2f}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid #252533;font-size:14px;vertical-align:top}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .small{font-size:12px;color:#bdbdc7}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #2b2b35;background:#181820;font-size:12px}
    /* Tab Styles */
    .tab-nav{border-bottom:1px solid #272733;margin-top:20px}
    .tab-link{background:transparent;color:#bdbdc7;border-radius:8px 8px 0 0;padding:10px 16px;border:1px solid transparent;border-bottom:0;margin-bottom:-1px}
    .tab-link.active{background:#141419;border-color:#272733;color:#fff;font-weight:500}
  </style>
</head>
<body>
<header><h1>Shifted Storage IPFS Cluster — Upload & Index</h1></header>
<main>

  <div class="card">
    <div class="small">
      Drop files to add & pin via Cluster REST (replication 1→2). Uses this NAS at <code>/api/cluster/*</code>.
    </div>
    <div id="drop" class="drop" style="margin-top:10px">
      Drop files here or <button id="pick" type="button" class="secondary">Select</button>
      <input id="file" type="file" multiple hidden>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="refresh" class="secondary">Refresh All</button>
    </div>
    <div id="log" class="small" style="margin-top:8px"></div>
  </div>

  <div class="tab-nav">
    <button class="tab-link active" onclick="openTab(event, 'pins-content')">Pinned Files</button>
    <button class="tab-link" onclick="openTab(event, 'peers-content')">Cluster Peers</button>
  </div>

  <div id="pins-content" class="tab-content">
      <div class="card" style="margin-top:0; border-top-left-radius:0;">
          <table>
              <thead><tr><th>Name</th><th>CID</th><th>Status</th><th></th></tr></thead>
              <tbody id="rows"></tbody>
          </table>
      </div>
  </div>

  <div id="peers-content" class="tab-content" style="display: none;">
      <div class="card" style="margin-top:0;">
          <table>
              <thead><tr><th>Peer ID</th><th>Addresses</th><th>Version</th></tr></thead>
              <tbody id="peer-rows"></tbody>
          </table>
      </div>
  </div>

</main>

<script>
const rows = document.getElementById('rows');
const peerRows = document.getElementById('peer-rows');
const logEl = document.getElementById('log');
const drop = document.getElementById('drop');
const pick = document.getElementById('pick');
const file = document.getElementById('file');
const refreshBtn = document.getElementById('refresh');

// ### NEW: Tab switching function ###
function openTab(evt, tabName) {
  const tabcontent = document.getElementsByClassName("tab-content");
  for (let i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  const tablinks = document.getElementsByClassName("tab-link");
  for (let i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.innerHTML = `[${t}] ${msg}<br>` + logEl.innerHTML;
}

async function listPins(){
  rows.innerHTML = '<tr><td colspan="4" class="small">Loading…</td></tr>';
  try {
    const res = await fetch('/api/cluster/pins', {
      headers: { 'Accept': 'application/x-ndjson' }
    });
    if (!res.ok) throw new Error('cluster /pins ' + res.status);

    const text = await res.text();
    const items = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(l => JSON.parse(l));

    rows.innerHTML = '';
    if (items.length === 0) {
      rows.innerHTML = '<tr><td colspan="4" class="small">No pins yet.</td></tr>';
      return;
    }
    for (const p of items) {
      const name = p.name || '';
      const cid  = p.cid  || '';
      const status = p.peer_map ? 'PINNED' : 'UNKNOWN';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${name ? name : '<span class="small">—</span>'}</td>
        <td class="mono">${cid}</td>
        <td><span class="pill">${status}</span></td>
        <td><button class="secondary" onclick="view('${cid}')">View</button></td>`;
      rows.appendChild(tr);
    }
  } catch (e) {
    rows.innerHTML = `<tr><td colspan="4" class="small">Error loading pins: ${e.message}</td></tr>`;
  }
}

async function listPeers() {
  peerRows.innerHTML = '<tr><td colspan="3" class="small">Loading…</td></tr>';
  try {
    const res = await fetch('/api/cluster/peers', {
        headers: { 'Accept': 'application/x-ndjson' }
    });
    if (!res.ok) throw new Error('cluster /peers ' + res.status);

    const text = await res.text();
    const peers = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean).map(l => JSON.parse(l));

    peerRows.innerHTML = '';
    if (peers.length === 0) {
      peerRows.innerHTML = '<tr><td colspan="3" class="small">No peers found.</td></tr>';
      return;
    }
    for (const p of peers) {
      const id = p.id || 'N/A';
      const addresses = p.addresses ? p.addresses.join('<br>') : 'N/A';
      const version = p.version || 'N/A';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono small">${id}</td>
        <td class="mono small">${addresses}</td>
        <td><span class="pill">${version}</span></td>`;
      peerRows.appendChild(tr);
    }
  } catch (e) {
    peerRows.innerHTML = `<tr><td colspan="3" class="small">Error loading peers: ${e.message}</td></tr>`;
  }
}

async function upload(files){
  for (const f of files) {
    const form = new FormData();
    form.append('file', f, f.name);
    const url = '/api/cluster/add?replication-min=1&replication-max=2&name=' + encodeURIComponent(f.name);
    log('Uploading ' + f.name + '…');
    try {
      const r = await fetch(url, { method: 'POST', body: form });
      if (!r.ok) throw new Error('add failed ' + r.status);
      const txt = await r.text();
      log('Added: ' + txt);
    } catch (e) {
      log('ERROR ' + f.name + ': ' + e.message);
    }
  }
  await listPins();
}

pick.onclick = () => file.click();
file.onchange = () => upload(file.files);

['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.add('drag'); }));
['dragleave','drop'].forEach(evt => drop.addEventListener(evt, e => { e.preventDefault(); drop.classList.remove('drag'); }));
drop.addEventListener('drop', e => {
  e.preventDefault();
  const files = e.dataTransfer.files;
  if (files && files.length) upload(files);
});

refreshBtn.onclick = () => {
    log('Refreshing both lists…');
    listPins();
    listPeers();
};

window.view = (cid) => {
  const gatewayUrl = 'https://shifted-edsu.tail1f6477.ts.net';
  window.open(`${gatewayUrl}/ipfs/${cid}`);
};

// Initial load for both lists
listPins();
listPeers();
</script>

</body>
</html>